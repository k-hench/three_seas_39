[
["index.html", "Three Seas 39 data analysis 1 Intro 1.1 Before you start 1.2 Data structure", " Three Seas 39 data analysis Kosmas Hench 2020-01-28 1 Intro 1.1 Before you start For the scripts to work, several R packages need to be installed. For the nMDS and Permanova script you‚Äôll need: install.packages(&quot;tidyverse&quot;) install.packages(&quot;ggalt&quot;) install.packages(&quot;vegan&quot;) install.packages(&quot;lubridate&quot;) For the maps with pie-charts the following additional packages are used: install.packages(&quot;sf&quot;) install.packages(&quot;scatterpie&quot;) install.packages(&quot;paletteer&quot;) install.packages(&quot;ggforce&quot;) install.packages(&quot;ggsn&quot;) install.packages(&quot;devtools&quot;) install.packages(&quot;ggstance&quot;) devtools::install_github(&quot;k-hench/hypoimg&quot;) Also note that at the time of writing, there are still several issues with the transect google sheet: cell U1 states ‚Äú8‚Äù when it should contain a species name (I think ‚Äújuvenile_dusky_damselfish‚Äù) cell BV1 is empty when it should contain a species name (note that currently the label of BU1 runs into BV1, group 1 &amp; 2 added counts - so they should know what species this is‚Ä¶) I am 99% sure that the counts of the ‚Äúblue hamlet‚Äù are actually black hamlets (otherwise add the blue hamlet to the fish list) 1.2 Data structure The scripts expect a folder called ‚Äúdata‚Äù within your project folder containing the following files: data/ ‚îú‚îÄ‚îÄ dive_spots - Sheet1.tsv ‚îú‚îÄ‚îÄ Fish_list_2020 - Sheet1.tsv ‚îú‚îÄ‚îÄ Fish_surveys - Sheet1.tsv ‚îú‚îÄ‚îÄ PAN_adm0.dbf ‚îú‚îÄ‚îÄ PAN_adm0.prj ‚îú‚îÄ‚îÄ PAN_adm0.sbn ‚îú‚îÄ‚îÄ PAN_adm0.sbx ‚îú‚îÄ‚îÄ PAN_adm0.shp ‚îî‚îÄ‚îÄ PAN_adm0.shx The data sheets (dive spots, fish list &amp; fish survey) were all exported from google sheets as tsv files: The PAN_admn0.* files are only needed for the map to plot the coast line of Panama. They were downloaded from gdam.org. "],
["nmds-and-permanova.html", "2 nMDS and Permanova 2.1 External pacakges 2.2 Custom functions 2.3 Loading data 2.4 Run nMDS 2.5 Permanova", " 2 nMDS and Permanova 2.1 External pacakges The script starts by loading all needed libraries. (Technically, the package lubridate is not important, I only used it to propperly format the date column, but the information is never used‚Ä¶ ) # loading all needed libraries # ----------------------------------- library(tidyverse) library(ggalt) library(vegan) library(lubridate) 2.2 Custom functions To make the code mode easily understandable (hopefully), we define some helper functions upfront (as opposed to ‚Äúin the middle of the process‚Äù): At some point we will need to fill the empty celly of our data sheet with zeros - by default R will fill empty cells with NA. For this we create a function, that will replace NA in all columns of a data frame except for a specific subset of columns (the ‚Äúnon-fish‚Äù columns). # setting up custom functions # ----------------------------------- # funtion to fill empty cells (NA) with zeros replace_all_na &lt;- function(tib, replace = 0, exclude = c(&quot;Date&quot;, &quot;location&quot;, &quot;group&quot;, &quot;habitat_type&quot;, &quot;depth&quot;)){ # get all fish columns (&quot;non-non-fish-columns&quot;) nm_replace &lt;- names(tib)[!(names(tib) %in% exclude)] # create a replacement list in the form of: list(fish_1 = 0, fish_2 = 0, ...) replace_list &lt;- rep(replace,length(nm_replace)) %&gt;% set_names(nm = nm_replace) %&gt;% as.list() # apply replacement list tib %&gt;% replace_na(replace = replace_list) } To make plotting the nMDS results with ggplot a little easier, we create a export function that will take the nMDS results as input and return a list with two data sets (output_name$spots - the transect scores and output_name$species - the species ‚Äúinfluence‚Äù). # funtion to export nmds results for plotting with ggplot export_nmds &lt;- function(tib, nmds, score_name = &quot;Spot&quot;, species_name = &quot;Species&quot;){ # doublecheck that rownames are uniqe, # otherwise the merge at the end duplicates entries if(any(duplicated(rownames(scores(nmds))))){ stop(paste(&quot;Sorry, the rownames of the distance matrix need to be unique. Currently that is not the case:\\n\\n &quot;, paste(c(&#39;!&#39;,&#39; &#39;)[2 - (duplicated(rownames(scores(nmds))) | duplicated(rownames(scores(nmds)), fromLast = TRUE))], rownames(scores(nmds)), collapse = &#39;\\n &#39;))) } # export obesravtions in nMDS space data_scores &lt;- as.data.frame(scores(nmds)) %&gt;% as_tibble(rownames = score_name) # export species in nMDS space data_species &lt;- as.data.frame(scores(nmds, &quot;species&quot;))%&gt;% as_tibble(rownames = species_name) list(spots = tib %&gt;% left_join(data_scores), species = data_species) } 2.3 Loading data Now, we are all set up and can start with the actual work. First, we need to import the survey data into R. Directly while importing we deal with some issues: we extract the pure site name from the location column (dropping the _mangrove suffix) we proppely format the date (actually transforming the column from character into date-type) since we have several transects per group, we number the transects within each group from the columns Site, habitat_type, group and transet_nr_within_group we create a unique identifier for each transect finally, we use the previously prepared function to replace all empty fish-cells with zeros Beware of the col_types = str_c(c('ccdc',rep('d', 78)),collapse = '') part: here we define the column types (c = character, d = ‚Äúdouble‚Äù/number). So I the original google sheet changes (eg. by a merge og ‚Äúblue hamlet‚Äù and ‚Äúblack hamlet‚Äù) the 78 needs to be updated to the total number of columns - 4! # ---------------------------------- # the actual script # ----------------------------------- # reading in the transect data and replacing NAs with zeros transects &lt;- read_tsv(&#39;data/Fish_surveys - Sheet1.tsv&#39;, col_types = str_c(c(&#39;ccdc&#39;,rep(&#39;d&#39;, 78)),collapse = &#39;&#39;)) %&gt;% # we need unique identifiers for each transect, # so we are going to assign a transet_nr_within_group group_by(location, group) %&gt;% mutate(Site = location %&gt;% str_to_lower() %&gt;% str_remove(&#39;_mangrove&#39;), transet_nr_within_group = row_number(), Date = Date %&gt;% str_replace(pattern = &quot;([0-9]*)/([0-9]*)/([0-9]*)&quot;, replacement = &quot;\\\\3-\\\\1-\\\\2&quot;) %&gt;% as_date(Date), Transect_id = str_c(Site, habitat_type, group, transet_nr_within_group ,sep = &#39;_&#39;)) %&gt;% ungroup() %&gt;% replace_all_na() ## Warning: Missing column names filled in: &#39;X74&#39; [74] After a first check, I realised that we will need to merge the observations within each group (eg. line 2 &amp; 3 or line 4 &amp; 5 of the original google sheet) - here we merge several rows of the data set. We also need to merge the observations over different stages (eg. juvenile_bluehead_wrasse &amp; bluehead_wrasse) - here we merge several columns. To do this merging we are going to apply some tidyverse-magic (using functions from the packages tidyr and dplyr). If you have difficulties following these rather complex steps, it might be helpful to highlight and execute just parts of the code (to see what is going on you will allways need to start with transects %&gt;% and NOT highlight the transects &lt;- bit): # merge by group and fish id transects &lt;- transects %&gt;% # transfrom the data from &quot;wide&quot; into &quot;long&quot; format # note that we select the fish columns here, so the bridled_goby:porkfish # part might need to be updated if the google cheet changes to the # form of fist_fish:last_fish pivot_longer(cols = bridled_goby:porkfish, names_to = &#39;common_name&#39;, values_to = &#39;n&#39;) %&gt;% # create a new column with the fish species (irrespective of stage) mutate(fish_id = common_name %&gt;% str_remove(&quot;_juvenile|juvenile_|initial_&quot;)) %&gt;% # set the logic to summarise over (we want one entry per species # for every site, habitat_type and group) group_by(Site, habitat_type, group, fish_id) %&gt;% # summ the counts according to our grouping summarise(n = sum(n)) %&gt;% # remove the grouping (the effect of this is not visible, # but if we don&#39;t do this the data table might behave strange later on..) ungroup() %&gt;% # reformat back to wide format (note that now the species are sorted alphabetically) pivot_wider(names_from = fish_id, values_from = n) %&gt;% # Since we now have only a single entry per group, # we update our transect identifiers mutate(Transect_id = str_c(Site, habitat_type, group, sep = &#39;_&#39;)) For some reason, some transects are completely empty (0 for all species). These are not informative in terms of community composition and need to be dropped from the data table (otherwise the nMDS will fail because there is no way to compute ecological distances with those transects). To check for this, we create a new column with the sum of all fish for each transect. transects &lt;- transects %&gt;% mutate(total_count = transects %&gt;% rowwise() %&gt;% select(-(Site:group),-Transect_id) %&gt;% rowSums()) Now we filter all transects that have a total count of zero. transects &lt;- transects %&gt;% filter(total_count != 0) 2.4 Run nMDS So far, we have worked with our data in the format of a data.frame, yet the nMDS expects a matrix (this just some internal stuff in R that has to do with the data stucture and you don‚Äôt rally have to worry about‚Ä¶). To prepare the nMDS input we select only the fish columns (note that the column order has changed and the fish are now sorted alphabetically) and convert these columns into a matrix. We store the transect ids in the rownames of the matrix (this is no data within the matrix and hence not considdered for the analysis). data_matrix &lt;- transects %&gt;% select(atlantic_spadefish:yellowtail_snapper) %&gt;% as.matrix() rownames(data_matrix) &lt;- transects$Transect_id Now we can run the nMDS on our data and export the results for ggplot. data_nmds &lt;- metaMDS(data_matrix, k = 2, trymax = 999, distance=&#39;bray&#39;) ## Square root transformation ## Wisconsin double standardization ## Run 0 stress 0.2054951 ## Run 1 stress 0.2073328 ## Run 2 stress 0.2110472 ## Run 3 stress 0.2089344 ## Run 4 stress 0.2112255 ## Run 5 stress 0.2072524 ## Run 6 stress 0.2076932 ## Run 7 stress 0.2061955 ## Run 8 stress 0.2277037 ## Run 9 stress 0.2251799 ## Run 10 stress 0.2120436 ## Run 11 stress 0.2061956 ## Run 12 stress 0.2158478 ## Run 13 stress 0.2061961 ## Run 14 stress 0.2232418 ## Run 15 stress 0.2089348 ## Run 16 stress 0.212634 ## Run 17 stress 0.2100794 ## Run 18 stress 0.229484 ## Run 19 stress 0.2061973 ## Run 20 stress 0.2226701 ## Run 21 stress 0.2269043 ## Run 22 stress 0.208934 ## Run 23 stress 0.2112546 ## Run 24 stress 0.2089026 ## Run 25 stress 0.2084581 ## Run 26 stress 0.2229818 ## Run 27 stress 0.2101229 ## Run 28 stress 0.225972 ## Run 29 stress 0.2114888 ## Run 30 stress 0.2158514 ## Run 31 stress 0.2115015 ## Run 32 stress 0.2102373 ## Run 33 stress 0.2061962 ## Run 34 stress 0.2084403 ## Run 35 stress 0.2084372 ## Run 36 stress 0.210387 ## Run 37 stress 0.2089371 ## Run 38 stress 0.2084382 ## Run 39 stress 0.2056559 ## ... Procrustes: rmse 0.01064424 max resid 0.05805437 ## Run 40 stress 0.2072531 ## Run 41 stress 0.2230131 ## Run 42 stress 0.2089486 ## Run 43 stress 0.2226318 ## Run 44 stress 0.2124895 ## Run 45 stress 0.2084525 ## Run 46 stress 0.2185491 ## Run 47 stress 0.212617 ## Run 48 stress 0.2116721 ## Run 49 stress 0.2099511 ## Run 50 stress 0.2310483 ## Run 51 stress 0.2125223 ## Run 52 stress 0.2112245 ## Run 53 stress 0.2084565 ## Run 54 stress 0.2061955 ## Run 55 stress 0.2112547 ## Run 56 stress 0.2109999 ## Run 57 stress 0.2126238 ## Run 58 stress 0.2069518 ## Run 59 stress 0.2124165 ## Run 60 stress 0.2101305 ## Run 61 stress 0.2134171 ## Run 62 stress 0.2056535 ## ... Procrustes: rmse 0.01052152 max resid 0.0585433 ## Run 63 stress 0.2073191 ## Run 64 stress 0.2076925 ## Run 65 stress 0.2182903 ## Run 66 stress 0.2159858 ## Run 67 stress 0.2061957 ## Run 68 stress 0.2104501 ## Run 69 stress 0.2123883 ## Run 70 stress 0.223215 ## Run 71 stress 0.2089352 ## Run 72 stress 0.2137481 ## Run 73 stress 0.2061977 ## Run 74 stress 0.2056535 ## ... Procrustes: rmse 0.01055998 max resid 0.05926682 ## Run 75 stress 0.2084524 ## Run 76 stress 0.2114861 ## Run 77 stress 0.2061957 ## Run 78 stress 0.2089639 ## Run 79 stress 0.2069527 ## Run 80 stress 0.206213 ## Run 81 stress 0.2110489 ## Run 82 stress 0.2089347 ## Run 83 stress 0.2123777 ## Run 84 stress 0.2103604 ## Run 85 stress 0.2126263 ## Run 86 stress 0.2123735 ## Run 87 stress 0.2123798 ## Run 88 stress 0.2056549 ## ... Procrustes: rmse 0.01064887 max resid 0.06014341 ## Run 89 stress 0.2056536 ## ... Procrustes: rmse 0.01056363 max resid 0.0588167 ## Run 90 stress 0.2084382 ## Run 91 stress 0.2089348 ## Run 92 stress 0.2104627 ## Run 93 stress 0.2159874 ## Run 94 stress 0.2061963 ## Run 95 stress 0.2110054 ## Run 96 stress 0.2105451 ## Run 97 stress 0.2343238 ## Run 98 stress 0.215314 ## Run 99 stress 0.2250141 ## Run 100 stress 0.2112248 ## Run 101 stress 0.2250305 ## Run 102 stress 0.2076914 ## Run 103 stress 0.2089026 ## Run 104 stress 0.206952 ## Run 105 stress 0.2160433 ## Run 106 stress 0.2110327 ## Run 107 stress 0.2089351 ## Run 108 stress 0.2061959 ## Run 109 stress 0.2310673 ## Run 110 stress 0.2100788 ## Run 111 stress 0.2061956 ## Run 112 stress 0.2167566 ## Run 113 stress 0.206197 ## Run 114 stress 0.2152961 ## Run 115 stress 0.2171266 ## Run 116 stress 0.206196 ## Run 117 stress 0.2143276 ## Run 118 stress 0.2159875 ## Run 119 stress 0.2153079 ## Run 120 stress 0.211664 ## Run 121 stress 0.2061955 ## Run 122 stress 0.2111632 ## Run 123 stress 0.2228563 ## Run 124 stress 0.2061956 ## Run 125 stress 0.2234943 ## Run 126 stress 0.2076915 ## Run 127 stress 0.2079455 ## Run 128 stress 0.2260427 ## Run 129 stress 0.2108587 ## Run 130 stress 0.2247557 ## Run 131 stress 0.2260429 ## Run 132 stress 0.2224012 ## Run 133 stress 0.2125277 ## Run 134 stress 0.2123009 ## Run 135 stress 0.2072541 ## Run 136 stress 0.2107816 ## Run 137 stress 0.2269081 ## Run 138 stress 0.2267632 ## Run 139 stress 0.2238753 ## Run 140 stress 0.2089608 ## Run 141 stress 0.2101249 ## Run 142 stress 0.2110071 ## Run 143 stress 0.2062129 ## Run 144 stress 0.2271357 ## Run 145 stress 0.2089359 ## Run 146 stress 0.2061963 ## Run 147 stress 0.2072647 ## Run 148 stress 0.2167583 ## Run 149 stress 0.208935 ## Run 150 stress 0.2161062 ## Run 151 stress 0.20566 ## ... Procrustes: rmse 0.005987957 max resid 0.02943882 ## Run 152 stress 0.2089053 ## Run 153 stress 0.2100831 ## Run 154 stress 0.2163064 ## Run 155 stress 0.2076934 ## Run 156 stress 0.2076075 ## Run 157 stress 0.2111609 ## Run 158 stress 0.2110051 ## Run 159 stress 0.206196 ## Run 160 stress 0.2115747 ## Run 161 stress 0.2114879 ## Run 162 stress 0.2108576 ## Run 163 stress 0.2272283 ## Run 164 stress 0.2061958 ## Run 165 stress 0.2281372 ## Run 166 stress 0.2112237 ## Run 167 stress 0.2124408 ## Run 168 stress 0.2084526 ## Run 169 stress 0.2137899 ## Run 170 stress 0.2061963 ## Run 171 stress 0.2056566 ## ... Procrustes: rmse 0.0105751 max resid 0.06038153 ## Run 172 stress 0.2056534 ## ... Procrustes: rmse 0.01054811 max resid 0.05924621 ## Run 173 stress 0.2105566 ## Run 174 stress 0.2101229 ## Run 175 stress 0.2084381 ## Run 176 stress 0.2128589 ## Run 177 stress 0.2076207 ## Run 178 stress 0.2121746 ## Run 179 stress 0.2061955 ## Run 180 stress 0.2160432 ## Run 181 stress 0.223066 ## Run 182 stress 0.2056537 ## ... Procrustes: rmse 0.01058809 max resid 0.05958554 ## Run 183 stress 0.222882 ## Run 184 stress 0.2084391 ## Run 185 stress 0.2265079 ## Run 186 stress 0.2132956 ## Run 187 stress 0.2185497 ## Run 188 stress 0.2105417 ## Run 189 stress 0.2133624 ## Run 190 stress 0.2124931 ## Run 191 stress 0.2123818 ## Run 192 stress 0.2226805 ## Run 193 stress 0.2061958 ## Run 194 stress 0.2115045 ## Run 195 stress 0.206196 ## Run 196 stress 0.2062142 ## Run 197 stress 0.2089391 ## Run 198 stress 0.2281036 ## Run 199 stress 0.2162323 ## Run 200 stress 0.2123821 ## Run 201 stress 0.2155047 ## Run 202 stress 0.2089485 ## Run 203 stress 0.2076913 ## Run 204 stress 0.2089355 ## Run 205 stress 0.2109996 ## Run 206 stress 0.2084579 ## Run 207 stress 0.2111613 ## Run 208 stress 0.2112233 ## Run 209 stress 0.2089345 ## Run 210 stress 0.212189 ## Run 211 stress 0.2177879 ## Run 212 stress 0.2295741 ## Run 213 stress 0.2061992 ## Run 214 stress 0.2247632 ## Run 215 stress 0.2260427 ## Run 216 stress 0.2250272 ## Run 217 stress 0.2267634 ## Run 218 stress 0.2115603 ## Run 219 stress 0.2125271 ## Run 220 stress 0.2123807 ## Run 221 stress 0.211908 ## Run 222 stress 0.2105442 ## Run 223 stress 0.2123835 ## Run 224 stress 0.2115023 ## Run 225 stress 0.2264694 ## Run 226 stress 0.2054933 ## ... New best solution ## ... Procrustes: rmse 0.001084309 max resid 0.004229843 ## ... Similar to previous best ## *** Solution reached # you can also try plot(data_nmds) at this point data_nmds_results &lt;- export_nmds(transects, data_nmds, score_name = &#39;Transect_id&#39;) ## Joining, by = &quot;Transect_id&quot; To look at the results we plot the exported data and color by habitat type: p1 &lt;- ggplot(data_nmds_results$spots, aes(x = NMDS1, y = NMDS2, group = habitat_type)) + # nMDS needs equal axis coord_equal() + # add lines for x = 0 and y = 0 geom_hline(yintercept = 0, color = &#39;lightgray&#39;, alpha = .4) + geom_vline(xintercept = 0, color = &#39;lightgray&#39;, alpha = .4) + # add indication of species influence geom_text(inherit.aes = FALSE, data = data_nmds_results$species, aes(x = NMDS1, y = NMDS2, label = Species)) + # add scoring of the transects geom_point(aes(colour = habitat_type), size = 2) + # add the outer hull for each habitat type geom_encircle(aes(colour = habitat_type, fill = habitat_type), s_shape = 1, alpha = 0.2, size = 1, expand = 0)+ # add a little space on either side of the plot (for text) scale_x_continuous(expand = c(.01,.05))+ # adjust plot layout theme(legend.position = &#39;bottom&#39;, panel.grid = element_blank()) # print plot p1 ## Warning: Removed 1 rows containing missing values (geom_text). Alternatively we can highlight the differnt sites using color. Note that all that has changed here is several replacements from colour = habitat_type to colour = Site - same for fill =. p2 &lt;- ggplot(data_nmds_results$spots, aes(x = NMDS1, y = NMDS2, group = Site)) + # nMDS needs equal axis coord_equal() + # add lines for x = 0 and y = 0 geom_hline(yintercept = 0, color = &#39;lightgray&#39;, alpha = .4) + geom_vline(xintercept = 0, color = &#39;lightgray&#39;, alpha = .4) + # add indication of species influence geom_text(inherit.aes = FALSE, data = data_nmds_results$species, aes(x = NMDS1, y = NMDS2, label = Species)) + # add scoring of the transects geom_point(aes(colour = Site), size = 2) + # add the outer hull for each site geom_encircle(aes(colour = Site, fill = Site), s_shape = 1, alpha = 0.2, size = 1, expand = 0)+ # add a little space on either side of the plot (for text) scale_x_continuous(expand = c(.01,.05))+ # adjust plot layout theme(legend.position = &#39;bottom&#39;, panel.grid = element_blank()) # print plot p2 ## Warning: Removed 1 rows containing missing values (geom_text). we can export these plots using ggsave(). ggsave(filename = &#39;nmds_by_haitat_type.pdf&#39;, plot = p1, width = 9, height = 9) ggsave(filename = &#39;nmds_by_site.pdf&#39;, plot = p2, width = 9, height = 9) 2.5 Permanova We can gain som insight from the nMDS plots, but if we want to check if the clusters on the nMDS are actually significantly differnt, we need to run a Permanova. The Permanova is also based on ecological differnces between the transects (just like nMDS), but here we need to compute the ourselves (nMDS does this step internally). # Permanova ------------------ # compute ecological distances between the transects distances &lt;- vegdist(data_matrix, distance = &#39;bray&#39;) # export the hapitat types according to order of the distance matrix distances_groups &lt;- transects[match(labels(distances), transects$Transect_id),]$habitat_type One point we unfortunately could not discuss in class (because of time üòø), is the fact that like many other statistical tests, Permanova also has some assumptions about our data. So, before we start, we need to check if the assumptions for permanova are met by our data (Anderson 2001): ‚ÄúThe only assumption of the test is that [‚Ä¶] the observations are independent and that they have similar distributions‚Äù This means that our data should be homogeneous dispersed - our clusters should be of approximately equal size (similar to equal variances when running an ANOVA or a t-test). The idea here is that if the clusters are of differnt sizes, the permanova might give a significant result because of the size diffence and not because of a difference in location of the clusters on the nMDS. To check for homogeneous dispersion, we can either use a statistical test (permutation test) or visualize the dispersion. # For the test for homogeneous dispersion we nee to compute the # distance of each transect to the center of its respective cluster # (s. https://k-hench.github.io/nmds/nmds.html#9 ) distances_betadispersion &lt;- betadisper(distances, distances_groups) # test homogenous dispersion permutest(distances_betadispersion) ## ## Permutation test for homogeneity of multivariate dispersions ## Permutation: free ## Number of permutations: 999 ## ## Response: Distances ## Df Sum Sq Mean Sq F N.Perm Pr(&gt;F) ## Groups 1 0.1401 0.140096 4.0667 999 0.045 * ## Residuals 44 1.5158 0.034449 ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 Here, we hope for a p-value larger than 0.05, since a value smaller than 0.05 would tell us that the dispersions of our clusters are indeed differnt (that the clusters are of different size). We can also inspect the distances of all transects to the center of their respective cluster visually for the same inforamtion: tibble(distances = distances_betadispersion$distances, habitat_type = distances_betadispersion$group) %&gt;% ggplot(aes(x = habitat_type, y = distances, fill = habitat_type))+ geom_boxplot() At the stage when I checked the data it looked like our data is very borderline - actually the clusters for mangrove and reef seem to be of different sizes. Fortunately the author of permanova basically told people to chill in such situations as long as their experimantal design was balanced (Anderson and Walsh 2013): ‚ÄúIn contrast, PERMANOVA and Pillai‚Äôs trace were largely unaffected by heterogeneity for balanced designs‚Äù So, lets quickly doublecheck: transects %&gt;% group_by(habitat_type) %&gt;% count() ## # A tibble: 2 x 2 ## # Groups: habitat_type [2] ## habitat_type n ## &lt;chr&gt; &lt;int&gt; ## 1 Mangrove 22 ## 2 Reef 24 To me 22/24 seems reasonably balanced, so we finally run the permanova: data_permanova &lt;- adonis(formula = distances ~ distances_groups, permutations = 999, method = &#39;bray&#39;) print(data_permanova) ## ## Call: ## adonis(formula = distances ~ distances_groups, permutations = 999, method = &quot;bray&quot;) ## ## Permutation: free ## Number of permutations: 999 ## ## Terms added sequentially (first to last) ## ## Df SumsOfSqs MeanSqs F.Model R2 Pr(&gt;F) ## distances_groups 1 3.9133 3.9133 14.904 0.25302 0.001 *** ## Residuals 44 11.5528 0.2626 0.74698 ## Total 45 15.4660 1.00000 ## --- ## Signif. codes: 0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1 At this point it is up to you to interpret the results - as far as stats go we‚Äôre done. References "],
["pie-charts-on-map.html", "3 pie-charts on map 3.1 Loading data", " 3 pie-charts on map Note that we need to drop the following entries unless you know their family: little_grey_guys little_guys_green Also, the following species need to be added to the fish list: flagfin_mojarra grey_snapper bearded_toadfish blue hamlet (unless changed to black hamlet) # loading all needed libraries # ----------------------------------- library(tidyverse) library(sf) library(scatterpie) library(paletteer) library(ggforce) library(ggsn) library(hypoimg) ## --- Welcome to hypoimg --- library(lubridate) library(ggstance) # setting up custom functions # ----------------------------------- # function to crop shapefiles to plot extent crp &lt;- function (poly, xlim = xlim_boc, ylim = ylim_boc) { st_intersection(poly, st_set_crs(st_as_sf(as(raster::extent(xlim[1], xlim[2], ylim[1], ylim[2]), &quot;SpatialPolygons&quot;)), st_crs(poly))) } # function to turn a data.frame (with the columns # &quot;Longitude&quot; and &quot;Latitude&quot;) into a spatial object tibble_to_sf &lt;- function(tib, crs = 4326){ tib %&gt;% st_as_sf(., coords = c(&quot;Longitude&quot;,&quot;Latitude&quot;)) %&gt;% st_set_crs(., crs) } # funtion to fill empty cells (NA) with zeros replace_all_na &lt;- function(tib, replace = 0, exclude = c(&quot;Date&quot;, &quot;location&quot;, &quot;group&quot;, &quot;habitat_type&quot;, &quot;depth&quot;)){ nm_replace &lt;- names(tib)[!(names(tib) %in% exclude)] replace_list &lt;- rep(replace,length(nm_replace)) %&gt;% set_names(nm = nm_replace) %&gt;% as.list() tib %&gt;% replace_na(replace = replace_list) } 3.1 Loading data Now, we are all set up and can start with the actual work. First, we need to import all the data sheets into R, starting with the survey data. # ----------------------------------- # the actual script # ----------------------------------- # setting the extent of the map xlim_boc &lt;- c(-82.5, -82) ylim_boc &lt;- c(9.1, 9.47) # reading the panama shape files and # cropping it to the plot extent # (downloaded from https://www.gadm.org/download_country_v3.html) bocas &lt;- read_sf(&#39;data/PAN_adm0.shp&#39;) %&gt;% crp() # reading in the dive sites for the gps locations sites &lt;- read_tsv(&#39;data/dive_spots - Sheet1.tsv&#39;) %&gt;% filter(!duplicated(Site)) %&gt;% select(Site, Latitude, Longitude) # reading in the transect data, replacing NAs with zeros # and merge with gps positions transects &lt;- read_tsv(&#39;data/Fish_surveys - Sheet1.tsv&#39;, col_types = str_c(c(&#39;ccdc&#39;,rep(&#39;d&#39;, 78)),collapse = &#39;&#39;)) %&gt;% mutate(Site = location %&gt;% str_to_lower() %&gt;% str_remove(&#39;_mangrove&#39;), Date = Date %&gt;% str_replace(pattern = &quot;([0-9]*)/([0-9]*)/([0-9]*)&quot;, replacement = &quot;\\\\3-\\\\1-\\\\2&quot;) %&gt;% as_date(Date)) %&gt;% replace_all_na() %&gt;% left_join(sites) # create a spatial object from the transects transects_sf &lt;- transects %&gt;% tibble_to_sf() # reading in the fish list for the fish families and create an ID column # for merging with the transect data fish_list &lt;- read_tsv(&#39;data/Fish_list_2020 - Sheet1.tsv&#39;) %&gt;% select(Common_name:`Family (latin name)`) %&gt;% # format the fish id column which is going to be # used for the merging with the transect data mutate(fish_id = Common_name ) ## Parsed with column specification: ## cols( ## Common_name = col_character(), ## `Latin name` = col_character(), ## `Family (common name)` = col_character(), ## `Family (latin name)` = col_character(), ## Phase = col_character(), ## Abundance = col_character(), ## `Date (YYYY-MM-DD)` = col_character(), ## Comments = col_character(), ## Observer = col_character(), ## Checked = col_character() ## ) # pie shift is set to define the distance between # the &quot;mangrove&quot; and &quot;reef&quot; pie for each location pie_shift &lt;- .03 # merge transect data and fish list summary_by_family &lt;- transects %&gt;% # we need unique identifiers for each transect, # so we are going to assign a transet_nr_within_group group_by(location, group) %&gt;% mutate(transet_nr_within_group = row_number(), transect_id = str_c(location, group, transet_nr_within_group, sep = &#39;_&#39;)) %&gt;% ungroup() %&gt;% # then we transform the data into &quot;long format&quot; to be able # to merge the family names based on the common name pivot_longer(cols = bridled_goby:porkfish, names_to = &#39;common_name&#39;) %&gt;% # from the common name we create a fish id that is in the EXACT same # format as the fish id column of the fish list data frame # (this requires some reformating, eg. dropping &#39;_juvenile&#39;) mutate(fish_id = common_name %&gt;% str_remove(&quot;_juvenile|juvenile_|initial_|intermediate_|juv_&quot;)) %&gt;% # merge with the fish list left_join(fish_list) %&gt;% # filter(!duplicated(fish_id)) %&gt;% # View() # drop all row that do not have an entry in the # fish list (typos &amp; missing) filter(!is.na(`Latin name`)) %&gt;% # sum the count for each family at each habitat type of each location group_by(`Family (latin name)`, Site, habitat_type) %&gt;% summarise(n = sum(value), Latitude = Latitude[[1]], Longitude = Longitude[[1]]) %&gt;% # transform back into &quot;wide format&quot; pivot_wider(names_from = `Family (latin name)`, values_from = n) %&gt;% # adjust positions of pies mutate(grp = str_c(Site, habitat_type, sep = &#39;_&#39;), Longitude = ifelse(habitat_type == &#39;Reef&#39;, Longitude - .5 * pie_shift, Longitude + .5 * pie_shift), Latitude = ifelse(habitat_type == &#39;Reef&#39;, Latitude - .5 * pie_shift, Latitude + .5 *pie_shift)) ## Joining, by = &quot;fish_id&quot; # select the names of all present fish families fish_columns &lt;- names(summary_by_family)[!(names(summary_by_family) %in% c(&quot;Date&quot;, &quot;Site&quot;, &quot;habitat_type&quot;, &quot;Latitude&quot;, &quot;Longitude&quot;, &quot;grp&quot;))] # set color coding for habitat type clr_habitat &lt;- c(rgb(0,0,0), rgb(1,1,1)) %&gt;% set_names(nm = c(&#39;Reef&#39;, &#39;Mangrove&#39;)) # import the compass image compass &lt;- hypo_read_svg(&#39;north.svg&#39;) # ----------------------------------- # plotting the map # ----------------------------------- # initalize the plot ggplot()+ # add the panama coastline geom_sf(data = bocas)+ # add the sampling sites (as dots) geom_sf(data = transects_sf)+ # add the pies geom_scatterpie(aes(x = Longitude, y = Latitude , r = .6 * pie_shift , group = grp), data = summary_by_family, color = rgb(1,1,1,0), cols = fish_columns) + # add a color coded ring around the pie to indicate habitat type geom_circle(data = summary_by_family, aes(x0 = Longitude, y0 = Latitude , r = .6 * pie_shift, color = habitat_type )) + # add the scalebar scalebar(x.min = -82.5, x.max = -82.3, y.min = 9.13, y.max = 9.17,transform = TRUE, dist = 10, dist_unit = &quot;km&quot;, st.dist = .35, st.size = 3.5, border.size = .1, height = .15)+ # add the compass annotation_custom(grob = compass, xmin = -82.49, xmax = -82.44, ymin = 9.4, ymax = 9.45)+ # set the color palette for the pies scale_fill_manual(values = paletteer_c(n = length(fish_columns), palette = &quot;ggthemes::Red-Green-Gold Diverging&quot;))+ # set the color palette for the habitat types scale_color_manual(values = clr_habitat, guide = FALSE )+ # remove any &quot;extra space&quot; on the x and y axis scale_x_continuous(expand = c(0,0))+ scale_y_continuous(expand = c(0,0))+ # foramt the legend guides(fill = guide_legend(title = &#39;Family&#39;, title.position = &#39;top&#39;))+ # twaek the plot appearance theme_minimal() + theme(axis.title = element_blank(), legend.key.size = unit(14,&#39;pt&#39;), legend.key.height = unit(14,&#39;pt&#39;), legend.background = element_rect(fill = &#39;lightgray&#39;, color = rgb(1,1,1,0)), legend.position = &#39;bottom&#39;) summary_by_family %&gt;% pivot_longer(cols = Acanthuridae:Urotrygonidae, names_to = &#39;Family&#39;, values_to = &#39;n&#39;) %&gt;% ggplot(aes(y = fct_reorder(Family, n), x = n, fill = Family))+ geom_barh(stat = &#39;identity&#39;)+ facet_grid(habitat_type ~ Site)+ scale_fill_manual(values = paletteer_c(n = length(fish_columns), palette = &quot;ggthemes::Red-Green-Gold Diverging&quot;))+ guides(fill = guide_legend(title = &#39;Family&#39;, title.position = &#39;top&#39;,nrow = 3))+ theme_minimal() + theme(axis.title = element_blank(), legend.key.size = unit(14,&#39;pt&#39;), legend.key.height = unit(14,&#39;pt&#39;), legend.background = element_rect(fill = &#39;lightgray&#39;, color = rgb(1,1,1,0)), legend.position = &#39;bottom&#39;) "]
]
