---
output: html_document
editor_options:
  chunk_output_type: console
---

# pie-charts on map

```{r, include = FALSE}
library(cowplot)
```

Note that we need to drop the following entries unless you know their family:

- little_grey_guys
- little_guys_green

Also, the following species need to be added to the fish list:

- flagfin_mojarra
- grey_snapper
- bearded_toadfish
- blue hamlet (unless changed to black hamlet)


```{r, warning = FALSE, message = FALSE}
# loading all needed libraries
# -----------------------------------
library(tidyverse)
library(sf)
library(scatterpie)
library(paletteer)
library(ggforce)
library(ggsn)
library(hypoimg)
library(lubridate)
library(ggstance)
```


```{r}
# setting up custom functions
# -----------------------------------

# function to crop shapefiles to plot extent 
crp <- function (poly, xlim = xlim_boc, ylim = ylim_boc) {
  st_intersection(poly, 
                  st_set_crs(st_as_sf(as(raster::extent(xlim[1],
                                                        xlim[2],
                                                        ylim[1],
                                                        ylim[2]), 
                                         "SpatialPolygons")),
                             st_crs(poly)))
}
```


```{r}
# function to turn a data.frame (with the columns
# "Longitude" and "Latitude") into a spatial object
tibble_to_sf <- function(tib, crs = 4326){
  tib %>%
    st_as_sf(., coords = c("Longitude","Latitude")) %>%
    st_set_crs(., crs)
}
```


```{r}
# funtion to fill empty cells (NA) with zeros 
replace_all_na <- function(tib, replace = 0, exclude = c("Date", "location", "group",
                                                         "habitat_type", "depth")){
  nm_replace <- names(tib)[!(names(tib) %in% exclude)]
  replace_list <- rep(replace,length(nm_replace)) %>% 
    set_names(nm = nm_replace) %>%
    as.list()
  
  tib %>% replace_na(replace = replace_list)
}
```

## Loading data

Now, we are all set up and can start with the actual work.

First, we need to import all the data sheets into R, starting with the survey data.

```{r}
# -----------------------------------
# the actual script
# -----------------------------------

# setting the extent of the map
xlim_boc <- c(-82.5, -82)
ylim_boc <- c(9.1, 9.47)
```


```{r, warning = FALSE, message = FALSE} 
# reading the panama shape files and
# cropping it to the plot extent
# (downloaded from https://www.gadm.org/download_country_v3.html)
bocas <- read_sf('data/PAN_adm0.shp') %>%
  crp()
```


```{r, warning = FALSE, message = FALSE}
# reading in the dive sites for the gps locations
sites <- read_tsv('data/dive_spots - Sheet1.tsv') %>%
  filter(!duplicated(Site)) %>%
  select(Site, Latitude, Longitude)
```


```{r, warning = FALSE, message = FALSE}
# reading in the transect data, replacing NAs with zeros
# and merge with gps positions
transects <- read_tsv('data/Fish_surveys - Sheet1.tsv',
                      col_types = str_c(c('ccdc',rep('d', 78)),collapse = '')) %>%
  mutate(Site = location %>% str_to_lower() %>% str_remove('_mangrove'),
         Date = Date %>%
           str_replace(pattern = "([0-9]*)/([0-9]*)/([0-9]*)",
                       replacement = "\\3-\\1-\\2") %>%
           as_date(Date)) %>%
  replace_all_na() %>%
  left_join(sites)
```


```{r}
# create a spatial object from the transects
transects_sf <- transects %>%
  tibble_to_sf()
```


```{r}
# reading in the fish list for the fish families and create an ID column
# for merging with the transect data
fish_list <- read_tsv('data/Fish_list_2020 - Sheet1.tsv') %>%
  select(Common_name:`Family (latin name)`) %>%
  # format the fish id column which is going to be
  # used for the merging with the transect data
  mutate(fish_id = Common_name )
```


```{r}
# pie shift is set to define the distance between
# the "mangrove" and "reef" pie for each location 
pie_shift <- .03
```


```{r}
# merge transect data and fish list
summary_by_family <- transects %>%
  # we need unique identifiers for each transect,
  # so we are going to assign a transet_nr_within_group 
  group_by(location, group) %>%
  mutate(transet_nr_within_group  = row_number(),
         transect_id = str_c(location, group,
                             transet_nr_within_group,
                             sep = '_')) %>%
  ungroup() %>%
  # then we transform the data into "long format" to be able
  # to merge the family names based on the common name
  pivot_longer(cols = bridled_goby:porkfish,
               names_to = 'common_name') %>% 
  # from the common name we create a fish id that is in the EXACT same
  # format as the fish id column of the fish list data frame
  # (this requires some reformating, eg. dropping '_juvenile')
  mutate(fish_id = common_name %>% 
           str_remove("_juvenile|juvenile_|initial_|intermediate_|juv_"))  %>%
  # merge with the fish list
  left_join(fish_list) %>% 
     # filter(!duplicated(fish_id)) %>%
     # View()
  # drop all row that do not have an entry in the
  # fish list (typos & missing)
  filter(!is.na(`Latin name`)) %>%
  # sum the count for each family at each habitat type of each location
  group_by(`Family (latin name)`, Site, habitat_type) %>%
  summarise(n = sum(value), Latitude = Latitude[[1]], Longitude = Longitude[[1]]) %>%
  # transform back into "wide format"
  pivot_wider(names_from = `Family (latin name)`, values_from = n) %>%
  # adjust positions of pies
  mutate(grp = str_c(Site, habitat_type, sep = '_'),
         Longitude = ifelse(habitat_type == 'Reef', Longitude - .5 * pie_shift, Longitude + .5 * pie_shift),
         Latitude = ifelse(habitat_type == 'Reef', Latitude - .5 * pie_shift, Latitude +  .5 *pie_shift))
```


```{r}
# select the names of all present fish families
fish_columns <- names(summary_by_family)[!(names(summary_by_family) %in%
                                             c("Date", "Site", "habitat_type", "Latitude",
                                               "Longitude", "grp"))]
```


```{r}
# set color coding for habitat type
clr_habitat <- c(rgb(0,0,0), rgb(1,1,1)) %>% 
  set_names(nm = c('Reef', 'Mangrove'))
```


```{r}
# import the compass image
compass <- hypo_read_svg('north.svg')
```


```{r, eval = FALSE, fig.width = 10.5, fig.height = 10.5}
# -----------------------------------
# plotting the map
# -----------------------------------

# initalize the plot
ggplot()+
  # add the panama coastline
  geom_sf(data = bocas)+
  # add the sampling sites (as dots)
  geom_sf(data = transects_sf)+
  # add the pies
  geom_scatterpie(aes(x = Longitude, y = Latitude ,
                      r = .6 * pie_shift , group = grp),
                  data = summary_by_family, color = rgb(1,1,1,0),
                  cols = fish_columns) +
  # add a color coded ring around the pie to indicate habitat type
  geom_circle(data = summary_by_family,
              aes(x0 = Longitude, y0 = Latitude ,
                  r = .6 * pie_shift, color = habitat_type )) +
  # add the scalebar
  scalebar(x.min = -82.5, x.max = -82.3,
           y.min = 9.13, y.max = 9.17,transform = TRUE,
           dist = 10, dist_unit = "km",
           st.dist = .35, st.size = 3.5,
           border.size = .1, height = .15)+
  # add the compass
  annotation_custom(grob = compass,
                    xmin = -82.49, xmax = -82.44,
                    ymin = 9.4, ymax = 9.45)+
  # set the color palette for the pies
  scale_fill_manual(values = paletteer_c(n = length(fish_columns),
                                         palette = "ggthemes::Red-Green-Gold Diverging"))+
  # set the color palette for the habitat types
  scale_color_manual(values = clr_habitat, guide = FALSE
                     )+
  # remove any "extra space" on the x and y axis
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0))+
  # foramt the legend
  guides(fill = guide_legend(title = 'Family',
                             title.position = 'top'))+
  # twaek the plot appearance
  theme_minimal() +
  theme(axis.title = element_blank(),
        legend.key.size = unit(14,'pt'),
        legend.key.height = unit(14,'pt'),
        legend.background = element_rect(fill = 'lightgray', 
                                         color = rgb(1,1,1,0)),
        legend.position = 'bottom')
```

```{r, echo = FALSE, fig.width = 10.5, fig.height = 10.5}
# -----------------------------------
# plotting the map
# -----------------------------------

# initalize the plot
ggdraw(ggplot()+
  # add the panama coastline
  geom_sf(data = bocas)+
  # add the sampling sites (as dots)
  geom_sf(data = transects_sf)+
  # add the pies
  geom_scatterpie(aes(x = Longitude, y = Latitude ,
                      r = .6 * pie_shift , group = grp),
                  data = summary_by_family, color = rgb(1,1,1,0),
                  cols = fish_columns) +
  # add a color coded ring around the pie to indicate habitat type
  geom_circle(data = summary_by_family,
              aes(x0 = Longitude, y0 = Latitude ,
                  r = .6 * pie_shift, color = habitat_type )) +
  # add the scalebar
  scalebar(x.min = -82.5, x.max = -82.3,
           y.min = 9.13, y.max = 9.17,transform = TRUE,
           dist = 10, dist_unit = "km",
           st.dist = .35, st.size = 3.5,
           border.size = .1, height = .15)+
  # add the compass
  annotation_custom(grob = compass,
                    xmin = -82.49, xmax = -82.44,
                    ymin = 9.4, ymax = 9.45)+
  # set the color palette for the pies
  scale_fill_manual(values = paletteer_c(n = length(fish_columns),
                                         palette = "ggthemes::Red-Green-Gold Diverging"))+
  # set the color palette for the habitat types
  scale_color_manual(values = clr_habitat, guide = FALSE
                     )+
  # remove any "extra space" on the x and y axis
  scale_x_continuous(expand = c(0,0))+
  scale_y_continuous(expand = c(0,0))+
  # foramt the legend
  guides(fill = guide_legend(title = 'Family',
                             title.position = 'top'))+
  # twaek the plot appearance
  theme_minimal() +
  theme(axis.title = element_blank(),
        legend.key.size = unit(14,'pt'),
        legend.key.height = unit(14,'pt'),
        legend.background = element_rect(fill = 'lightgray', 
                                         color = rgb(1,1,1,0)),
        legend.position = 'bottom')) + 
  draw_label("tutorial version", color = "#FF000055", size = 60, angle = 45)
```

```{r, eval = FALSE}
summary_by_family %>%
  pivot_longer(cols = Acanthuridae:Urotrygonidae,
               names_to = 'Family', values_to = 'n') %>%
  ggplot(aes(y = fct_reorder(Family, n), x = n, fill = Family))+
  geom_barh(stat = 'identity')+
  facet_grid(habitat_type ~ Site)+
  scale_fill_manual(values = paletteer_c(n = length(fish_columns),
                                         palette = "ggthemes::Red-Green-Gold Diverging"))+
  guides(fill = guide_legend(title = 'Family',
                             title.position = 'top',nrow = 3))+
  theme_minimal() +
  theme(axis.title = element_blank(),
        legend.key.size = unit(14,'pt'),
        legend.key.height = unit(14,'pt'),
        legend.background = element_rect(fill = 'lightgray', 
                                         color = rgb(1,1,1,0)),
        legend.position = 'bottom')
```

```{r, echo = FALSE, fig.width = 10.5, fig.height = 10.5}
ggdraw(summary_by_family %>%
  pivot_longer(cols = Acanthuridae:Urotrygonidae,
               names_to = 'Family', values_to = 'n') %>%
  ggplot(aes(y = fct_reorder(Family, n), x = n, fill = Family))+
  geom_barh(stat = 'identity')+
  facet_grid(habitat_type ~ Site)+
  scale_fill_manual(values = paletteer_c(n = length(fish_columns),
                                         palette = "ggthemes::Red-Green-Gold Diverging"))+
  guides(fill = guide_legend(title = 'Family',
                             title.position = 'top',nrow = 3))+
  theme_minimal() +
  theme(axis.title = element_blank(),
        legend.key.size = unit(14,'pt'),
        legend.key.height = unit(14,'pt'),
        legend.background = element_rect(fill = 'lightgray', 
                                         color = rgb(1,1,1,0)),
        legend.position = 'bottom')) + 
  draw_label("tutorial version", color = "#FF000055", size = 60, angle = 45)
```
